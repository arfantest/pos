<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white border-b sticky top-0 z-10 px-4 py-3">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-2xl font-bold text-gray-900">New Purchase Order</h1>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 pb-32">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
            <!-- Left Column - Account, Supplier, Product Search -->
            <div class="lg:col-span-2 space-y-4">
                <!-- Account Selection -->
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                        <span nz-icon nzType="bank" class="mr-2 text-blue-600"></span>
                        Account
                    </h3>

                    <nz-select [(ngModel)]="selectedAccountId" nzPlaceHolder="Choose account"
                        (ngModelChange)="onAccountChange()" class="w-full" nzSize="small">
                        <nz-option *ngFor="let account of accounts" [nzValue]="account.id" [nzLabel]="account.name">
                            <div class="flex justify-between items-center">
                                <span class="text-sm">{{ account.name }}</span>
                                <nz-tag [nzColor]="getAccountStatusColor(account.balance)" nzSize="small">
                                    {{ account.balance | number:'1.2-2' }}
                                </nz-tag>
                            </div>
                        </nz-option>
                    </nz-select>

                    <!-- Compact Account Info -->
                    <div *ngIf="selectedAccount" class="bg-gray-50 rounded p-3 mt-3">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-gray-600">Balance:</span>
                            <span class="font-semibold"
                                [class]="selectedAccount.balance >= 0 ? 'text-green-600' : 'text-red-600'">
                                {{ selectedAccount.balance | number:'1.2-2' }}
                            </span>
                        </div>
                        <div class="flex justify-between items-center text-sm mt-1">
                            <span class="text-gray-600">Status:</span>
                            <nz-tag [nzColor]="selectedAccount.isActive ? 'green' : 'red'" nzSize="small">
                                {{ selectedAccount.isActive ? 'Active' : 'Inactive' }}
                            </nz-tag>
                        </div>
                    </div>
                </div>

                <!-- Supplier Information -->
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                        <span nz-icon nzType="team" class="mr-2 text-purple-600"></span>
                        Supplier
                    </h3>

                    <form nz-form [formGroup]="purchaseForm" class="space-y-3">
                        <nz-form-item class="mb-2">
                            <nz-form-control nzErrorTip="Please input supplier name!">
                                <input nz-input formControlName="supplierName" placeholder="Supplier Name *"
                                    nzSize="small" />
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item class="mb-2">
                            <nz-form-control>
                                <input nz-input formControlName="supplierContact" placeholder="Contact (Phone/Email)"
                                    nzSize="small" />
                            </nz-form-control>
                        </nz-form-item>

                        <nz-form-item class="mb-2">
                            <nz-form-control>
                                <input nz-input formControlName="supplierAddress" placeholder="Address (Optional)"
                                    nzSize="small" />
                            </nz-form-control>
                        </nz-form-item>
                    </form>
                </div>

                <!-- Product Search -->
                <div class="bg-white rounded-lg shadow-sm border p-4" style="margin-bottom: 80px;">
                    <h3 class="text-sm font-semibold text-gray-900 mb-3 flex items-center">
                        <span nz-icon nzType="search" class="mr-2 text-green-600"></span>
                        Search Products
                    </h3>

                    <nz-input-group nzSearch [nzAddOnAfter]="suffixIconButton" class="mb-3">
                        <input type="text" nz-input placeholder="Search products..." [(ngModel)]="searchText"
                            (input)="onSearch()" (keyup.enter)="onBarcodeSearch()" nzSize="small" />
                    </nz-input-group>
                    <ng-template #suffixIconButton>
                        <button nz-button nzType="primary" nzSearch (click)="onBarcodeSearch()" nzSize="small">
                            <span nz-icon nzType="search"></span>
                        </button>
                    </ng-template>

                    <!-- Improved Product List -->
                    <div class="max-h-80 overflow-y-auto space-y-2" *ngIf="filteredProducts.length > 0">
                        <div *ngFor="let product of filteredProducts.slice(0, 15)"
                            class="group border border-gray-200 rounded-lg p-3 hover:border-blue-400 hover:bg-blue-50 transition-all cursor-pointer bg-white"
                            (click)="addToCart(product)">
                            <div class="flex justify-between items-center">
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1 min-w-0 pr-2">
                                            <h4 class="font-medium text-gray-900 text-sm truncate">{{ product.name }}
                                            </h4>
                                            <div class="flex items-center space-x-2 mt-1">
                                                <span class="text-xs text-gray-500">{{ product.sku }}</span>
                                                <span class="text-xs px-2 py-1 bg-gray-100 rounded-full">
                                                    Stock: {{ product.stock }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <p class="text-sm font-bold text-blue-600">{{ product.cost | number:'1.2-2'
                                                }}</p>
                                            <button nz-button nzType="primary" nzSize="small"
                                                class="mt-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <span nz-icon nzType="plus"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div *ngIf="searchText && filteredProducts.length === 0" class="text-center py-6 text-gray-500">
                        <span nz-icon nzType="inbox" class="text-xl block mb-2"></span>
                        <span class="text-sm">No products found</span>
                    </div>
                </div>
            </div>

            <!-- Right Column - Cart -->
            <div class="lg:col-span-3">
                <!-- Purchase Cart -->
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                            <span nz-icon nzType="shopping-cart" class="mr-2 text-orange-600"></span>
                            Purchase Cart ({{ cart.length }} items)
                        </h3>
                        <button nz-button nzType="text" nzSize="small" (click)="clearCart()" *ngIf="cart.length > 0"
                            nzDanger>
                            <span nz-icon nzType="delete"></span>
                            Clear
                        </button>
                    </div>

                    <!-- Empty Cart State -->
                    <div *ngIf="cart.length === 0" class="text-center py-16 text-gray-500">
                        <span nz-icon nzType="shopping-cart" class="text-4xl block mb-4 text-gray-300"></span>
                        <p class="text-lg font-medium">Cart is empty</p>
                        <p class="text-sm">Search and add products to get started</p>
                    </div>

                    <!-- Enhanced Cart Items -->
                    <div *ngIf="cart.length > 0" class="space-y-3 max-h-96 overflow-y-auto">
                        <div *ngFor="let item of cart; let i = index"
                            class="border border-gray-200 rounded-lg p-4 bg-gradient-to-r from-gray-50 to-white hover:shadow-md transition-shadow">
                            <div class="grid grid-cols-12 gap-3 items-center">
                                <!-- Product Info (5 columns) -->
                                <div class="col-span-5">
                                    <h4 class="font-semibold text-gray-900 text-sm mb-1">{{ item.product.name }}</h4>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">{{
                                            item.product.sku }}</span>
                                        <span class="text-xs font-medium text-blue-600">Stock: {{ item.product.stock
                                            }}</span>
                                    </div>
                                </div>

                                <!-- Unit Cost (2 columns) -->
                                <div class="col-span-2 text-center">
                                    <div class="text-xs text-gray-500 mb-1 font-medium">Unit Cost</div>
                                    <nz-input-number [(ngModel)]="item.unitCost" [nzMin]="0" [nzStep]="0.01"
                                        [nzPrecision]="2" (ngModelChange)="updateCartItem(i)" class="w-full"
                                        nzSize="small"></nz-input-number>
                                </div>

                                <!-- Quantity (2 columns) -->
                                <div class="col-span-2 text-center">
                                    <div class="text-xs text-gray-500 mb-1 font-medium">Qty</div>
                                    <nz-input-number [(ngModel)]="item.quantity" [nzMin]="1"
                                        (ngModelChange)="updateCartItem(i)" class="w-full"
                                        nzSize="small"></nz-input-number>
                                </div>

                                <!-- Total (2 columns) -->
                                <div class="col-span-2 text-center">
                                    <div class="text-xs text-gray-500 mb-1 font-medium">Total</div>
                                    <span class="text-base font-bold text-green-600 ml-2">{{ item.total | number:'1.2-2'
                                        }}</span>
                                </div>

                                <!-- Remove Button (1 column) -->
                                <div class="col-span-1 text-center">
                                    <button nz-button nzType="text" nzDanger (click)="removeFromCart(i)" nzSize="small"
                                        class="hover:bg-red-50">
                                        <span nz-icon nzType="delete"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Fixed Bottom Section with Discount -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t-2 border-gray-200 shadow-2xl z-20"
        *ngIf="cart.length > 0">
        <div class="max-w-7xl mx-auto">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 p-4 items-center">
                <!-- Discount Section (3 columns) -->
                <div class="lg:col-span-3">
                    <div class="bg-gradient-to-r from-orange-50 to-yellow-50 rounded-lg p-4 border border-orange-200">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center">
                            <span nz-icon nzType="percentage" class="mr-2 text-orange-600"></span>
                            Discount
                        </h4>

                        <!-- Discount Amount Input -->
                        <div class="mb-3">
                            <label class="text-xs font-medium text-gray-600 block mb-1">Amount</label>
                            <nz-input-number [(ngModel)]="discountAmountInput" [nzMin]="0" [nzMax]="subtotal"
                                [nzStep]="0.01" [nzPrecision]="2" (ngModelChange)="onDiscountAmountChange()"
                                class="w-full" nzPlaceHolder="0.00" nzSize="small">
                            </nz-input-number>
                        </div>

                        <!-- Discount Percentage Input -->
                        <div class="mb-2">
                            <label class="text-xs font-medium text-gray-600 block mb-1">Percentage (%)</label>
                            <nz-input-number [(ngModel)]="discountPercentageInput" [nzMin]="0" [nzMax]="100"
                                [nzStep]="1" [nzPrecision]="1" (ngModelChange)="onDiscountPercentageChange()"
                                class="w-full" nzPlaceHolder="0" nzSize="small">
                            </nz-input-number>
                        </div>

                        <!-- Quick Discount Buttons -->
                        <div class="flex space-x-1 mt-2">
                            <button nz-button nzSize="small" nzType="default" (click)="setQuickDiscount(5)"
                                class="flex-1 text-xs">5%</button>
                            <button nz-button nzSize="small" nzType="default" (click)="setQuickDiscount(10)"
                                class="flex-1 text-xs">10%</button>
                            <button nz-button nzSize="small" nzType="default" (click)="setQuickDiscount(15)"
                                class="flex-1 text-xs">15%</button>
                            <button nz-button nzSize="small" nzType="text" (click)="clearDiscount()"
                                class="flex-1 text-xs text-red-600">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Payment Input (3 columns) -->
                <div class="lg:col-span-3">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <label class="text-sm font-semibold text-gray-700 block mb-2">
                            <span nz-icon nzType="wallet" class="mr-1"></span>
                            Amount Paid
                        </label>
                        <nz-input-number [(ngModel)]="paid" [nzMin]="0" [nzStep]="0.01" [nzPrecision]="2"
                            (ngModelChange)="calculateTotals()" class="w-full" nzPlaceHolder="0.00"
                            nzSize="large"></nz-input-number>
                        <div class="text-sm mt-2 font-medium" [class]="change >= 0 ? 'text-green-600' : 'text-red-600'"
                            *ngIf="paid && paid > 0">
                            <span nz-icon [nzType]="change >= 0 ? 'arrow-up' : 'arrow-down'" class="mr-1"></span>
                            Change: {{ change | number:'1.2-2' }}
                        </div>
                    </div>
                </div>

                <!-- Totals Summary (3 columns) -->
                <div class="lg:col-span-3">
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-lg p-4 border border-blue-200">
                        <div class="space-y-2">
                            <!-- Subtotal -->
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Subtotal:</span>
                                <span class="font-medium">{{ subtotal | number:'1.2-2' }}</span>
                            </div>

                            <!-- Discount -->
                            <div class="flex justify-between text-sm text-gray-600" *ngIf="discountAmount > 0">
                                <span>
                                    Discount ({{ discountPercentage | number:'1.1-1' }}%):
                                </span>
                                <span class="text-red-600 font-medium">-{{ discountAmount | number:'1.2-2' }}</span>
                            </div>

                            <!-- Tax -->
                            <div class="flex justify-between text-sm text-gray-600">
                                <span>Tax:</span>
                                <span class="font-medium ml-4">{{ taxAmount | number:'1.2-2' }}</span>
                            </div>

                            <!-- Total After Discount -->
                            <div class="border-t border-gray-300 pt-2">
                                <div class="flex justify-between text-base font-bold">
                                    <span class="text-gray-800">Total:</span>
                                    <span class="text-blue-600">{{ total | number:'1.2-2' }}</span>
                                </div>
                            </div>

                            <!-- Payment Information -->
                            <div class="flex justify-between text-sm text-gray-600" *ngIf="paid > 0">
                                <span>Amount Paid:</span>
                                <span class="text-green-600 font-medium">-{{ paid | number:'1.2-2' }}</span>
                            </div>

                            <!-- Remaining Balance -->
                            <div class="border-t border-gray-300 pt-2">
                                <div class="flex justify-between text-lg font-bold">
                                    <span class="text-gray-800">Remaining Balance:</span>
                                    <span class="text-green-600">{{ remainingTotal | number:'1.2-2' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons (3 columns) -->
                <div class="lg:col-span-3 flex flex-col items-end space-y-3 w-64">
                    <button nz-button nzType="primary" nzSize="large" [nzLoading]="processing"
                        [disabled]="!canCreatePurchase()" (click)="createPurchase()"
                        class="px-8 flex items-center justify-center bg-blue-600 border-blue-600 hover:bg-blue-700 w-full">
                        <span nz-icon nzType="check-circle" class="mr-2"></span>
                        Create Purchase
                    </button>

                    <button nz-button nzType="default" (click)="clearCart()" nzSize="large"
                        class="flex items-center justify-center w-full">
                        <span nz-icon nzType="delete" class="mr-1"></span>
                        Clear Cart
                    </button>
                </div>

            </div>
        </div>
    </div>
</div>